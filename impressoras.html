<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Configurar Impressora</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/gh/qzind/tray/qz-tray.js"></script>
</head>
<body class="p-4" style="font-family: 'Segoe UI', sans-serif; background-color: #fff;">
  <h3>🖨️ Configuração de Impressora</h3>
  <p>Escolha uma impressora instalada no seu computador para imprimir os pedidos automaticamente.</p>

  <div class="mb-3">
    <label for="selectImpressora" class="form-label">Impressora disponível:</label>
    <select class="form-select" id="selectImpressora">
      <option value="">Carregando impressoras...</option>
    </select>
  </div>

  <button class="btn btn-primary mb-3" onclick="salvarImpressora()">Salvar Impressora</button>
  <button class="btn btn-outline-secondary mb-3 ms-2" onclick="testeImpressao()">🧪 Testar Impressão</button>

  <div id="status" class="mt-3 text-success"></div>

  <script>
    const supabase = window.supabase.createClient(
      'https://oyoirjgfwsvtfmsvecfd.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95b2lyamdmd3N2dGZtc3ZlY2ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyMTI3NjMsImV4cCI6MjA2Mzc4ODc2M30.s6MkXu1bGKgGsQj6ovea9d9bfOwRi-4sitHdCJb08G8'
    );

    async function carregarImpressoras() {
      try {
        await qz.websocket.connect();
        const printers = await qz.printers.find();
        const select = document.getElementById('selectImpressora');
        select.innerHTML = printers.map(p => `<option value="${p}">${p}</option>`).join('');

        // Tentar buscar impressora salva no Supabase
        const { data, error } = await supabase
          .from('configuracoes_empresa')
          .select('valor')
          .eq('tipo', 'impressora_pedidos')
          .single();

        if (data && data.valor) {
          select.value = data.valor;
        }
      } catch (err) {
        alert("Erro ao conectar com o QZ Tray. Verifique se ele está instalado e rodando.");
        console.error(err);
      }
    }

    async function salvarImpressora() {
      const impressora = document.getElementById('selectImpressora').value;
      if (!impressora) return alert("Selecione uma impressora.");

      const { error } = await supabase
        .from('configuracoes_empresa')
        .upsert([
          { tipo: 'impressora_pedidos', valor: impressora }
        ], { onConflict: ['tipo'] });

      if (error) {
        console.error(error);
        return alert("Erro ao salvar no banco de dados.");
      }

      document.getElementById('status').innerText = "Impressora salva com sucesso no Supabase!";
    }

    function testeImpressao() {
      const impressora = document.getElementById('selectImpressora').value;
      if (!impressora) return alert("Nenhuma impressora selecionada.");

      const config = qz.configs.create(impressora);
      const data = [
        "--------------------------------",
        "     TESTE DE IMPRESSÃO",
        "     Smash do Cabo - OK",
        "--------------------------------",
        "Data: " + new Date().toLocaleString()
      ];
      qz.print(config, data).then(() => {
        alert("Impressão enviada com sucesso!");
      }).catch(err => alert("Erro ao imprimir: " + err));
    }

    carregarImpressoras();
  </script>
</body>
</html>
