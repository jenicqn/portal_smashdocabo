<div class="container py-4 px-4">
  <h2>Perfil da Empresa</h2>

  <div class="row mb-4">
    <div class="col-md-6 text-center">
      <img id="previewBanner" class="img-fluid mb-2" style="max-height:160px; display:none;" />
      <input type="file" id="bannerInput" accept="image/*" class="form-control" onchange="previewImage(event, 'previewBanner')" />
    </div>
    <div class="col-md-6 text-center">
      <img id="previewLogo" class="rounded-circle mb-2" style="width:100px; height:100px; object-fit:cover; display:none;" />
      <input type="file" id="logoInput" accept="image/*" class="form-control" onchange="previewImage(event, 'previewLogo')" />
    </div>
  </div>

  <form id="perfilForm">
    <input type="hidden" id="id" value="c794a76e-ed6d-4119-b2ac-52b6fcb793a2" />
    
    <div class="row g-3">
      <div class="col-md-4">
        <label for="nome" class="form-label">Nome</label>
        <input type="text" id="nome" class="form-control" />
      </div>
      <div class="col-md-4">
        <label for="telefone" class="form-label">Telefone</label>
        <input type="text" id="telefone" class="form-control" />
      </div>
      <div class="col-md-4">
        <label for="cnpj" class="form-label">CNPJ</label>
        <input type="text" id="cnpj" class="form-control" />
      </div>
      <div class="col-md-4">
        <label for="cor_menu" class="form-label">Cor do Menu</label>
        <input type="color" id="cor_menu" class="form-control form-control-color" value="#2596be" />
      </div>
      <div class="col-md-4">
        <label for="whatsapp" class="form-label">Whatsapp</label>
        <input type="text" id="whatsapp" class="form-control" />
      </div>
      <div class="col-md-4">
        <label for="instagram" class="form-label">Instagram</label>
        <input type="text" id="instagram" class="form-control" />
      </div>
      <div class="col-md-12">
        <label for="descricao" class="form-label">Descrição</label>
        <textarea id="descricao" class="form-control" rows="2"></textarea>
      </div>
      <div class="col-md-4">
        <label for="pedido_minimo" class="form-label">Pedido Mínimo</label>
        <input type="number" id="pedido_minimo" class="form-control" />
      </div>
      <div class="col-md-8">
        <label for="obs" class="form-label">Observação Final</label>
        <input type="text" id="obs" class="form-control" />
      </div>
    </div>

    <div class="mt-4 text-end">
      <button type="button" class="btn btn-primary px-4" onclick="salvarPerfil()">Salvar Alterações</button>
    </div>
  </form>
</div>

<!-- Supabase & JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const { createClient } = supabase;
  const supabaseClient = createClient(
    'https://oyoirjgfwsvtfmsvecfd.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95b2lyamdmd3N2dGZtc3ZlY2ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyMTI3NjMsImV4cCI6MjA2Mzc4ODc2M30.s6MkXu1bGKgGsQj6ovea9d9bfOwRi-4sitHdCJb08G8'
  );

  function previewImage(event, id) {
    const reader = new FileReader();
    reader.onload = () => {
      const img = document.getElementById(id);
      img.src = reader.result;
      img.style.display = "block";
    };
    reader.readAsDataURL(event.target.files[0]);
  }

  async function salvarPerfil() {
    const data = {
      id: document.getElementById("id").value,
      nome: document.getElementById("nome").value,
      telefone: document.getElementById("telefone").value,
      cnpj: document.getElementById("cnpj").value,
      cor_menu: document.getElementById("cor_menu").value,
      whatsapp: document.getElementById("whatsapp").value,
      instagram: document.getElementById("instagram").value,
      descricao: document.getElementById("descricao").value,
      pedido_minimo: parseFloat(document.getElementById("pedido_minimo").value) || 0,
      obs_finalizacao: document.getElementById("obs").value
    };

    const { data: result, error } = await supabaseClient
      .from("empresa")
      .upsert([data], { onConflict: ['id'] });

    if (error) {
      alert("❌ Erro ao salvar: " + error.message);
      console.error(error);
    } else {
      alert("✅ Alterações salvas com sucesso!");
      console.log("Salvo:", result);
    }
  }
</script>
